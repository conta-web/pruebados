<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema Control IVA</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      background: #f4f5f7;
      padding: 20px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(15, 23, 42, 0.08);
      border: none;
    }
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 10px;
    }
    .app-title {
      font-size: 1.4rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .badge-soft {
      background: #e0f2fe;
      color: #0369a1;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
    }
    .nav-pills .nav-link {
      border-radius: 999px;
      font-weight: 500;
    }
    .nav-pills .nav-link.active {
      background: #0f172a;
    }
    .table thead {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .chip-activo {
      background: #dcfce7;
      color: #166534;
    }
    .chip-inactivo {
      background: #fee2e2;
      color: #991b1b;
    }
    .chip-pendiente {
      background: #fef3c7;
      color: #92400e;
    }
    .chip-presentado {
      background: #e0f2fe;
      color: #075985;
    }
    .chip-multa {
      background: #fee2e2;
      color: #b91c1c;
    }
    .chip-riesgo-bajo {
      background: #dcfce7;
      color: #166534;
    }
    .chip-riesgo-medio {
      background: #fef3c7;
      color: #92400e;
    }
    .chip-riesgo-alto {
      background: #fee2e2;
      color: #b91c1c;
    }
    .chip-riesgo-sin {
      background: #e5e7eb;
      color: #374151;
    }
    .btn-sm {
      border-radius: 999px;
      font-size: 0.75rem;
      padding-inline: 10px;
    }
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-subtitle {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 16px;
    }
    .form-label {
      font-size: 0.8rem;
      font-weight: 500;
    }
    .text-regimen {
      font-size: 0.75rem;
      color: #4b5563;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div class="app-header">
      <div class="app-title">
        üìä Sistema Control de Clientes IVA
        <span class="badge-soft">Versi√≥n local (navegador)</span>
      </div>
      <small class="text-muted">
        Basado en Ley de IVA (13%) y C√≥digo Tributario de El Salvador. <br>
        Datos guardados en este navegador con <strong>localStorage</strong>.
      </small>
    </div>

    <!-- NAV TABS -->
    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active"
          id="pills-dashboard-tab"
          data-bs-toggle="pill"
          data-bs-target="#pills-dashboard"
          type="button"
          role="tab"
        >
          Inicio / Dashboard
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="pills-clientes-tab"
          data-bs-toggle="pill"
          data-bs-target="#pills-clientes"
          type="button"
          role="tab"
        >
          Clientes IVA
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="pills-declaraciones-tab"
          data-bs-toggle="pill"
          data-bs-target="#pills-declaraciones"
          type="button"
          role="tab"
        >
          Declaraciones mensuales
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="pills-ganancias-tab"
          data-bs-toggle="pill"
          data-bs-target="#pills-ganancias"
          type="button"
          role="tab"
        >
          Ganancias estimadas
        </button>
      </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
      <!-- ================== PESTA√ëA DASHBOARD ================== -->
      <div
        class="tab-pane fade show active"
        id="pills-dashboard"
        role="tabpanel"
      >
        <div class="row g-3">
          <div class="col-md-3">
            <div class="card h-100">
              <div class="card-body">
                <div class="section-title">üë• Clientes</div>
                <p class="mb-1"><small>Activos</small></p>
                <div class="fs-4 fw-bold" id="dashClientesActivos">0</div>
                <p class="mb-1 mt-2"><small>Inactivos</small></p>
                <div class="fs-6" id="dashClientesInactivos">0</div>
              </div>
            </div>
          </div>
          <div class="col-md-5">
            <div class="card h-100">
              <div class="card-body">
                <div class="section-title">üìÖ Declaraciones mes actual</div>
                <p class="mb-1">
                  Presentadas: <strong id="dashDecPresentadas">0</strong>
                </p>
                <p class="mb-1">
                  Pendientes: <strong id="dashDecPendientes">0</strong>
                </p>
                <p class="mb-0">
                  Con multa: <strong id="dashDecMulta">0</strong>
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="section-title">üí∏ Impuestos del mes</div>
                <p class="mb-1">
                  IVA: <strong>$<span id="dashImpIVA">0.00</span></strong>
                </p>
                <p class="mb-1">
                  Pago a cuenta:
                  <strong>$<span id="dashImpPagoCuenta">0.00</span></strong>
                </p>
                <p class="mb-0">
                  ISR estimado:
                  <strong>$<span id="dashImpISR">0.00</span></strong>
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="section-title">üö¶ Riesgo por clientes</div>
                <p class="mb-1">
                  Riesgo bajo: <strong id="dashRiesgoBajo">0</strong>
                </p>
                <p class="mb-1">
                  Riesgo medio: <strong id="dashRiesgoMedio">0</strong>
                </p>
                <p class="mb-1">
                  Riesgo alto: <strong id="dashRiesgoAlto">0</strong>
                </p>
                <p class="mb-0 text-muted">
                  <small>Basado en √∫ltimos 12 meses de declaraciones.</small>
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card h-100">
              <div class="card-body">
                <div class="section-title">
                  üóìÔ∏è Agenda tributaria
                </div>
                <div class="section-subtitle">
                  Pr√≥ximos vencimientos de declaraciones. Ordenado por d√≠as
                  restantes.
                </div>
                <div class="table-responsive" style="max-height:260px;">
                  <table class="table table-hover align-middle mb-0">
                    <thead>
                      <tr>
                        <th>Cliente</th>
                        <th>Periodo</th>
                        <th>Vence</th>
                        <th>Estado</th>
                        <th>D√≠as</th>
                        <th>Prioridad</th>
                      </tr>
                    </thead>
                    <tbody id="tablaAgenda"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ================== PESTA√ëA CLIENTES ================== -->
      <div
        class="tab-pane fade"
        id="pills-clientes"
        role="tabpanel"
      >
        <div class="row g-3">
          <!-- FORM CLIENTE -->
          <div class="col-lg-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="section-title">
                  üßæ Cliente IVA
                </div>
                <div class="section-subtitle">
                  Registra o edita los datos generales de tus contribuyentes.
                  La clasificaci√≥n (peque√±o, mediano, gran contribuyente) se basa en los criterios de la DGII
                  sobre volumen de operaciones y obligaciones como agente de retenci√≥n/percepci√≥n.
                </div>

                <form id="formCliente">
                  <input type="hidden" id="clienteIndex" />
                  <div class="mb-2">
                    <label class="form-label">Nombre / Raz√≥n Social</label>
                    <input
                      type="text"
                      id="cli_nombre"
                      class="form-control form-control-sm"
                      required
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">NIT</label>
                    <input
                      type="text"
                      id="cli_nit"
                      class="form-control form-control-sm"
                      required
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">NRC</label>
                    <input
                      type="text"
                      id="cli_nrc"
                      class="form-control form-control-sm"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Giro</label>
                    <input
                      type="text"
                      id="cli_giro"
                      class="form-control form-control-sm"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Correo</label>
                    <input
                      type="email"
                      id="cli_correo"
                      class="form-control form-control-sm"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tel√©fono</label>
                    <input
                      type="text"
                      id="cli_telefono"
                      class="form-control form-control-sm"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tipo de contribuyente</label>
                    <select
                      id="cli_regimen"
                      class="form-select form-select-sm"
                    >
                      <option value="Peque√±o contribuyente">Peque√±o contribuyente</option>
                      <option value="Mediano contribuyente">Mediano contribuyente</option>
                      <option value="Gran contribuyente">Gran contribuyente</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Fecha inscripci√≥n IVA</label>
                    <input
                      type="date"
                      id="cli_fechaInscripcion"
                      class="form-control form-control-sm"
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Estado</label>
                    <select id="cli_estado" class="form-select form-select-sm">
                      <option value="Activo">Activo</option>
                      <option value="Inactivo">Inactivo</option>
                    </select>
                  </div>

                  <div class="d-flex gap-2">
                    <button
                      type="submit"
                      class="btn btn-dark btn-sm flex-grow-1"
                    >
                      Guardar
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-secondary btn-sm"
                      onclick="resetFormCliente()"
                    >
                      Nuevo
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- LISTA CLIENTES -->
          <div class="col-lg-8">
            <div class="card h-100">
              <div class="card-body">
                <div class="section-title">
                  üìö Listado de Clientes
                </div>
                <div class="section-subtitle">
                  Selecciona un cliente para usarlo luego en las declaraciones y en el an√°lisis de ganancias.
                </div>

                <div class="table-responsive" style="max-height: 420px;">
                  <table class="table table-hover align-middle mb-0">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Nombre</th>
                        <th>NIT</th>
                        <th>Tipo contribuyente</th>
                        <th>Riesgo</th>
                        <th>Estado</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="tablaClientes"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ================== PESTA√ëA DECLARACIONES ================== -->
      <div class="tab-pane fade" id="pills-declaraciones" role="tabpanel">
        <div class="row g-3">
          <!-- FORM DECLARACI√ìN -->
          <div class="col-lg-4">
            <div class="card h-100">
              <div class="card-body">
                <div class="section-title">
                  üìÖ Declaraci√≥n Mensual
                </div>
                <div class="section-subtitle">
                  C√°lculo simplificado seg√∫n normativa salvadore√±a:  
                  IVA general 13% (Ley de IVA), pago a cuenta 1.5% sobre ventas y ISR estimado 25% sobre utilidad.  
                  Ajusta manualmente si tu caso requiere un tratamiento especial.
                </div>

                <form id="formDeclaracion">
                  <input type="hidden" id="decIndex" />
                  <div class="mb-2">
                    <label class="form-label">Cliente</label>
                    <select
                      id="dec_idCliente"
                      class="form-select form-select-sm"
                      required
                    >
                      <option value="">Seleccione...</option>
                    </select>
                    <div id="infoRegimen" class="text-regimen mt-1">
                      Selecciona un cliente para ver su clasificaci√≥n como contribuyente.
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-6 mb-2">
                      <label class="form-label">Mes</label>
                      <select
                        id="dec_mes"
                        class="form-select form-select-sm"
                        required
                      >
                        <option value="">Mes...</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                      </select>
                    </div>
                    <div class="col-6 mb-2">
                      <label class="form-label">A√±o</label>
                      <input
                        type="number"
                        id="dec_anio"
                        class="form-control form-control-sm"
                        min="2000"
                        max="2100"
                        required
                      />
                    </div>
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Ventas gravadas</label>
                    <input
                      type="number"
                      step="0.01"
                      id="dec_ventasGravadas"
                      class="form-control form-control-sm"
                      value="0"
                      oninput="recalcularImpuestos()"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Ventas exentas</label>
                    <input
                      type="number"
                      step="0.01"
                      id="dec_ventasExentas"
                      class="form-control form-control-sm"
                      value="0"
                      oninput="recalcularImpuestos()"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Compras gravadas</label>
                    <input
                      type="number"
                      step="0.01"
                      id="dec_comprasGravadas"
                      class="form-control form-control-sm"
                      value="0"
                      oninput="recalcularImpuestos()"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Compras exentas</label>
                    <input
                      type="number"
                      step="0.01"
                      id="dec_comprasExentas"
                      class="form-control form-control-sm"
                      value="0"
                      oninput="recalcularImpuestos()"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Cr√©dito fiscal</label>
                    <input
                      type="number"
                      step="0.01"
                      id="dec_creditoFiscal"
                      class="form-control form-control-sm"
                      value="0"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">D√©bito fiscal</label>
                    <input
                      type="number"
                      step="0.01"
                      id="dec_debitoFiscal"
                      class="form-control form-control-sm"
                      value="0"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">IVA a pagar (positivo) / a favor (negativo)</label>
                    <input
                      type="number"
                      step="0.01"
                      id="dec_ivaPagar"
                      class="form-control form-control-sm"
                      value="0"
                    />
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Pago a Cuenta (1.5% sobre ventas)</label>
                    <input
                      type="number"
                      step="0.01"
                      id="dec_pagoCuenta"
                      class="form-control form-control-sm"
                      value="0"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">ISR estimado (25% utilidad simple)</label>
                    <input
                      type="number"
                      step="0.01"
                      id="dec_isrEstimado"
                      class="form-control form-control-sm"
                      value="0"
                    />
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Fecha presentaci√≥n</label>
                    <input
                      type="date"
                      id="dec_fechaPresentacion"
                      class="form-control form-control-sm"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Estado</label>
                    <select
                      id="dec_estado"
                      class="form-select form-select-sm"
                    >
                      <option value="Pendiente">Pendiente</option>
                      <option value="Presentado">Presentado</option>
                      <option value="Con multa">Con multa</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Observaciones</label>
                    <textarea
                      id="dec_observaciones"
                      rows="2"
                      class="form-control form-control-sm"
                    ></textarea>
                  </div>

                  <div class="d-flex gap-2">
                    <button
                      type="submit"
                      class="btn btn-dark btn-sm flex-grow-1"
                    >
                      Guardar
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-secondary btn-sm"
                      onclick="resetFormDeclaracion()"
                    >
                      Nuevo
                    </button>
                  </div>

                  <small class="text-muted d-block mt-3">
                    Nota: la clasificaci√≥n como gran o mediano contribuyente tambi√©n implica
                    obligaciones como agente de retenci√≥n/percepci√≥n seg√∫n el C√≥digo Tributario.
                  </small>
                </form>
              </div>
            </div>
          </div>

          <!-- LISTA DECLARACIONES -->
          <div class="col-lg-8">
            <div class="card h-100">
              <div class="card-body">
                <div class="section-title">
                  üìë Resumen de Declaraciones
                </div>
                <div class="section-subtitle">
                  Vista r√°pida del estado de cumplimiento mensual por cliente.  
                  El campo <strong>‚ÄúIVA favor acum.‚Äù</strong> muestra el IVA a favor acumulado por cliente.
                </div>

                <div class="table-responsive" style="max-height: 420px;">
                  <table class="table table-hover align-middle mb-2">
                    <thead>
                      <tr>
                        <th>Cliente</th>
                        <th>Tipo contribuyente</th>
                        <th>Mes/A√±o</th>
                        <th>D√©bito</th>
                        <th>Cr√©dito</th>
                        <th>IVA pagar</th>
                        <th>Pago cta</th>
                        <th>ISR est.</th>
                        <th>IVA favor acum.</th>
                        <th>Estado</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="tablaDeclaraciones"></tbody>
                  </table>
                </div>

                <div class="mt-2 text-end">
                  <small class="text-muted">
                    Tip: m√°s adelante esto se puede exportar a Excel o PDF.
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ================== PESTA√ëA GANANCIAS ================== -->
      <div class="tab-pane fade" id="pills-ganancias" role="tabpanel">
        <div class="row g-3">
          <div class="col-12">
            <div class="card h-100">
              <div class="card-body">
                <div class="section-title">
                  üí∞ Ganancias estimadas despu√©s de impuestos
                </div>
                <div class="section-subtitle">
                  Ganancia neta aproximada usando info de las declaraciones:  
                  <strong>Ganancia neta ‚âà (Ventas - Compras) - (IVA pagado + Pago a cuenta + ISR estimado)</strong>.  
                  El IVA negativo se considera ‚Äúa favor‚Äù y no se descuenta como pago del mes.
                </div>

                <div class="row mb-3">
                  <div class="col-md-4">
                    <label class="form-label">Filtrar por cliente</label>
                    <select id="filtroGanCliente" class="form-select form-select-sm" onchange="renderGanancias()">
                      <option value="">Todos</option>
                    </select>
                  </div>
                </div>

                <div class="section-title">
                  üîé Detalle por periodo
                </div>
                <div class="table-responsive" style="max-height: 260px;">
                  <table class="table table-hover align-middle mb-2">
                    <thead>
                      <tr>
                        <th>Cliente</th>
                        <th>Tipo contribuyente</th>
                        <th>Mes/A√±o</th>
                        <th>Ventas</th>
                        <th>Compras</th>
                        <th>Utilidad</th>
                        <th>IVA pagado</th>
                        <th>Pago cta</th>
                        <th>ISR</th>
                        <th>Imp. totales</th>
                        <th>Ganancia neta</th>
                      </tr>
                    </thead>
                    <tbody id="tablaGananciasDetalle"></tbody>
                  </table>
                </div>

                <hr class="my-3">

                <div class="section-title">
                  üìä Resumen por cliente
                </div>
                <div class="table-responsive" style="max-height: 220px;">
                  <table class="table table-sm align-middle mb-0">
                    <thead>
                      <tr>
                        <th>Cliente</th>
                        <th>Tipo contribuyente</th>
                        <th>Ventas</th>
                        <th>Compras</th>
                        <th>Utilidad</th>
                        <th>IVA pagado</th>
                        <th>Pago cta</th>
                        <th>ISR</th>
                        <th>Imp. totales</th>
                        <th>Ganancia neta</th>
                      </tr>
                    </thead>
                    <tbody id="tablaGananciasClientes"></tbody>
                  </table>
                </div>

                <small class="text-muted d-block mt-3">
                  Referencia legal: Ley del IVA (tasa general 13%) y C√≥digo Tributario de El Salvador  
                  sobre agentes de retenci√≥n/percepci√≥n y clasificaci√≥n de contribuyentes.
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ======= STORAGE =======
    function cargarDesdeStorage(clave) {
      try {
        const data = localStorage.getItem(clave);
        return data ? JSON.parse(data) : [];
      } catch (e) {
        console.warn("Error leyendo", clave, e);
        return [];
      }
    }

    let clientes = cargarDesdeStorage("clientesIVA");
    let declaraciones = cargarDesdeStorage("declaracionesIVA");

    function guardarStorage() {
      localStorage.setItem("clientesIVA", JSON.stringify(clientes));
      localStorage.setItem("declaracionesIVA", JSON.stringify(declaraciones));
    }

    // ======= CONSTANTES IMPUESTOS =======
    const TASA_IVA = 0.13;
    const TASA_PAGO_CTA = 0.015;
    const TASA_ISR = 0.25;

    // ======= UTILIDADES GENERALES =======
    function mostrarNombreRegimen(valor) {
      if (!valor) return "-";
      const v = valor.toLowerCase();
      if (v.includes("peque")) return "Peque√±o contribuyente";
      if (v.includes("mediano")) return "Mediano contribuyente";
      if (v.includes("gran")) return "Gran contribuyente";
      if (v.includes("com√∫n") || v.includes("general")) return "Mediano contribuyente";
      return valor;
    }

    function actualizarInfoRegimen() {
      const sel = document.getElementById("dec_idCliente");
      const info = document.getElementById("infoRegimen");
      const idxCliente = parseInt(sel.value, 10);

      if (isNaN(idxCliente) || !clientes[idxCliente]) {
        info.textContent = "Selecciona un cliente para ver su clasificaci√≥n como contribuyente.";
        return;
      }

      const reg = mostrarNombreRegimen(clientes[idxCliente].regimen);

      if (reg === "Gran contribuyente") {
        info.textContent =
          "Gran contribuyente: clasificado as√≠ por la Administraci√≥n Tributaria; usualmente act√∫a como agente de retenci√≥n y percepci√≥n de IVA.";
      } else if (reg === "Mediano contribuyente") {
        info.textContent =
          "Mediano contribuyente: volumen de operaciones intermedio; tambi√©n puede ser designado agente de retenci√≥n/percepci√≥n seg√∫n C√≥digo Tributario.";
      } else if (reg === "Peque√±o contribuyente") {
        info.textContent =
          "Peque√±o contribuyente: menor volumen de operaciones. Mantiene las obligaciones de IVA (13%) y renta, pero con menor impacto que medianos y grandes.";
      } else {
        info.textContent = "Clasificaci√≥n personalizada de contribuyente.";
      }
    }

    function obtenerPeriodoActual() {
      const hoy = new Date();
      return {
        mes: hoy.getMonth() + 1,
        anio: hoy.getFullYear(),
      };
    }

    function calcularFechaVencimiento(dec) {
      // Vencimiento: d√≠a 21 del mes siguiente al periodo declarado
      let mes = dec.mes + 1;
      let anio = dec.anio;
      if (mes === 13) {
        mes = 1;
        anio++;
      }
      return new Date(anio, mes - 1, 21);
    }

    function normalizarFechaSinHora(fecha) {
      return new Date(fecha.getFullYear(), fecha.getMonth(), fecha.getDate());
    }

    function formatFechaCorta(fecha) {
      const d = String(fecha.getDate()).padStart(2, "0");
      const m = String(fecha.getMonth() + 1).padStart(2, "0");
      const y = fecha.getFullYear();
      return `${d}/${m}/${y}`;
    }

    // ======= C√ÅLCULO IMPUESTOS (El Salvador ‚Äì simplificado) =======
    function recalcularImpuestos() {
      const ventasGrav = parseFloat(document.getElementById("dec_ventasGravadas").value) || 0;
      const ventasExen = parseFloat(document.getElementById("dec_ventasExentas").value) || 0;
      const comprasGrav = parseFloat(document.getElementById("dec_comprasGravadas").value) || 0;
      const comprasExen = parseFloat(document.getElementById("dec_comprasExentas").value) || 0;

      const debito = ventasGrav * TASA_IVA;
      const credito = comprasGrav * TASA_IVA;
      const ivaPagar = debito - credito;  // puede ser negativo (IVA a favor)

      document.getElementById("dec_debitoFiscal").value = debito.toFixed(2);
      document.getElementById("dec_creditoFiscal").value = credito.toFixed(2);
      document.getElementById("dec_ivaPagar").value = ivaPagar.toFixed(2);

      const basePagoCuenta = ventasGrav + ventasExen;
      const pagoCuenta = basePagoCuenta * TASA_PAGO_CTA;
      document.getElementById("dec_pagoCuenta").value = pagoCuenta.toFixed(2);

      const utilidadEstimada =
        (ventasGrav + ventasExen) - (comprasGrav + comprasExen);
      const isrEstimado = utilidadEstimada > 0 ? utilidadEstimada * TASA_ISR : 0;
      document.getElementById("dec_isrEstimado").value = isrEstimado.toFixed(2);
    }

    // ======= IVA A FAVOR ACUMULADO =======
    function calcularSaldosIVA() {
      declaraciones.forEach(d => {
        delete d.saldoIVA;
      });

      const porCliente = {};

      declaraciones.forEach((d, i) => {
        if (!porCliente[d.idCliente]) {
          porCliente[d.idCliente] = [];
        }
        porCliente[d.idCliente].push(i);
      });

      Object.keys(porCliente).forEach(id => {
        const indices = porCliente[id];

        indices.sort((a, b) => {
          const da = declaraciones[a];
          const db = declaraciones[b];
          if (da.anio !== db.anio) return da.anio - db.anio;
          return da.mes - db.mes;
        });

        let saldoFavor = 0;

        indices.forEach(idx => {
          const d = declaraciones[idx];
          const iva = Number(d.ivaPagar || 0);

          if (iva < 0) {
            saldoFavor += Math.abs(iva);
          } else if (iva > 0) {
            if (saldoFavor >= iva) {
              saldoFavor -= iva;
            } else {
              saldoFavor = 0;
            }
          }

          d.saldoIVA = saldoFavor;
        });
      });
    }

    // ======= C√ÅLCULO RIESGO POR CLIENTE =======
    function calcularRiesgoPorCliente() {
      const hoy = normalizarFechaSinHora(new Date());
      const inicioPeriodo = new Date(hoy.getFullYear(), hoy.getMonth() - 11, 1);

      const stats = {};

      declaraciones.forEach(d => {
        const fechaPeriodo = new Date(d.anio, d.mes - 1, 1);
        if (fechaPeriodo < inicioPeriodo) return;

        if (!stats[d.idCliente]) {
          stats[d.idCliente] = {
            total: 0,
            presentadas: 0,
            multas: 0,
            pendientesEnPlazo: 0,
            pendientesVencidas: 0,
          };
        }
        const st = stats[d.idCliente];
        st.total++;

        const venc = calcularFechaVencimiento(d);
        const dias = Math.floor((calcularFechaVencimiento(d) - hoy) / (1000 * 60 * 60 * 24));

        if (d.estado === "Presentado") {
          st.presentadas++;
        } else if (d.estado === "Con multa") {
          st.multas++;
        } else if (d.estado === "Pendiente") {
          if (dias >= 0) st.pendientesEnPlazo++;
          else st.pendientesVencidas++;
        }
      });

      const resultado = {};
      clientes.forEach((c, idx) => {
        const st = stats[idx];
        if (!st || st.total === 0) {
          resultado[idx] = {
            nivel: "Sin historial",
            etiqueta: "Sin historial",
            clase: "chip chip-riesgo-sin",
          };
          return;
        }

        let nivel, etiqueta, clase;
        if (st.multas >= 3 || st.pendientesVencidas >= 2) {
          nivel = "Alto";
          etiqueta = "Alto";
          clase = "chip chip-riesgo-alto";
        } else if (st.multas >= 1 || st.pendientesVencidas === 1) {
          nivel = "Medio";
          etiqueta = "Medio";
          clase = "chip chip-riesgo-medio";
        } else {
          nivel = "Bajo";
          etiqueta = "Bajo";
          clase = "chip chip-riesgo-bajo";
        }

        resultado[idx] = { nivel, etiqueta, clase };
      });

      return resultado;
    }

    // ======= DASHBOARD + AGENDA =======
    function renderDashboard() {
      const spActivos = document.getElementById("dashClientesActivos");
      if (!spActivos) return; // por seguridad

      const activos = clientes.filter(c => c.estado === "Activo").length;
      const inactivos = clientes.length - activos;

      spActivos.textContent = activos;
      document.getElementById("dashClientesInactivos").textContent = inactivos;

      const { mes, anio } = obtenerPeriodoActual();
      let presentadas = 0;
      let pendientes = 0;
      let conMulta = 0;
      let totalIva = 0;
      let totalPago = 0;
      let totalIsr = 0;

      declaraciones.forEach(d => {
        if (d.mes === mes && d.anio === anio) {
          if (d.estado === "Presentado") presentadas++;
          else if (d.estado === "Con multa") conMulta++;
          else pendientes++;

          totalIva += Math.max(0, Number(d.ivaPagar || 0));
          totalPago += Number(d.pagoCuenta || 0);
          totalIsr += Number(d.isrEstimado || 0);
        }
      });

      document.getElementById("dashDecPresentadas").textContent = presentadas;
      document.getElementById("dashDecPendientes").textContent = pendientes;
      document.getElementById("dashDecMulta").textContent = conMulta;

      document.getElementById("dashImpIVA").textContent = totalIva.toFixed(2);
      document.getElementById("dashImpPagoCuenta").textContent = totalPago.toFixed(2);
      document.getElementById("dashImpISR").textContent = totalIsr.toFixed(2);

      const riesgos = calcularRiesgoPorCliente();
      let bajos = 0, medios = 0, altos = 0;

      clientes.forEach((c, idx) => {
        const r = riesgos[idx];
        if (!r) return;
        if (r.nivel === "Bajo") bajos++;
        else if (r.nivel === "Medio") medios++;
        else if (r.nivel === "Alto") altos++;
      });

      document.getElementById("dashRiesgoBajo").textContent = bajos;
      document.getElementById("dashRiesgoMedio").textContent = medios;
      document.getElementById("dashRiesgoAlto").textContent = altos;

      // Agenda tributaria
      const tbodyAgenda = document.getElementById("tablaAgenda");
      tbodyAgenda.innerHTML = "";

      if (!declaraciones.length) {
        tbodyAgenda.innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-muted">
              No hay declaraciones registradas.
            </td>
          </tr>`;
        return;
      }

      const hoy = normalizarFechaSinHora(new Date());
      const items = [];

      declaraciones.forEach(d => {
        const cli = clientes[d.idCliente];
        const nombre = cli ? cli.nombre : "(cliente eliminado)";
        const periodo = `${d.mes}/${d.anio}`;
        const venc = calcularFechaVencimiento(d);
        const vencSinHora = normalizarFechaSinHora(venc);
        const dias = Math.floor((vencSinHora - hoy) / (1000 * 60 * 60 * 24));

        let prioridad, chipClase;
        if (dias < 0) {
          prioridad = "Vencido";
          chipClase = "chip chip-multa";
        } else if (dias <= 5) {
          prioridad = "Alta";
          chipClase = "chip chip-multa";
        } else if (dias <= 10) {
          prioridad = "Media";
          chipClase = "chip chip-pendiente";
        } else {
          prioridad = "Baja";
          chipClase = "chip chip-presentado";
        }

        let textoDias;
        if (dias === 0) textoDias = "Hoy";
        else if (dias > 0) textoDias = `En ${dias} d√≠as`;
        else textoDias = `Hace ${Math.abs(dias)} d√≠as`;

        items.push({
          nombre,
          periodo,
          venc,
          estado: d.estado,
          dias,
          prioridad,
          chipClase,
          textoDias,
        });
      });

      items.sort((a, b) => a.dias - b.dias);

      items.forEach(it => {
        tbodyAgenda.innerHTML += `
          <tr>
            <td>${it.nombre}</td>
            <td>${it.periodo}</td>
            <td>${formatFechaCorta(it.venc)}</td>
            <td>${it.estado}</td>
            <td>${it.textoDias}</td>
            <td><span class="${it.chipClase}">${it.prioridad}</span></td>
          </tr>
        `;
      });
    }

    // ======= CLIENTES =======
    function renderClientes() {
      const tbody = document.getElementById("tablaClientes");
      const selClientes = document.getElementById("dec_idCliente");
      const selFiltroGan = document.getElementById("filtroGanCliente");

      tbody.innerHTML = "";
      const riesgos = calcularRiesgoPorCliente();

      if (selClientes) {
        selClientes.innerHTML = '<option value="">Seleccione...</option>';
      }
      if (selFiltroGan) {
        const oldVal = selFiltroGan.value;
        selFiltroGan.innerHTML = '<option value="">Todos</option>';
        clientes.forEach((c, i) => {
          selFiltroGan.innerHTML += `<option value="${i}">${c.nombre}</option>`;
        });
        const optExists = Array.from(selFiltroGan.options).some(o => o.value === oldVal);
        if (optExists) selFiltroGan.value = oldVal;
      }

      clientes.forEach((c, i) => {
        const estadoClass =
          c.estado === "Activo" ? "chip chip-activo" : "chip chip-inactivo";

        const infoRiesgo = riesgos[i] || {
          etiqueta: "Sin historial",
          clase: "chip chip-riesgo-sin",
        };

        tbody.innerHTML += `
          <tr>
            <td>${i + 1}</td>
            <td>${c.nombre}</td>
            <td>${c.nit || "-"}</td>
            <td>${mostrarNombreRegimen(c.regimen)}</td>
            <td><span class="${infoRiesgo.clase}">${infoRiesgo.etiqueta}</span></td>
            <td><span class="${estadoClass}">${c.estado}</span></td>
            <td class="text-end">
              <button class="btn btn-outline-dark btn-sm" onclick="editarCliente(${i})">Editar</button>
              <button class="btn btn-outline-danger btn-sm" onclick="eliminarCliente(${i})">Borrar</button>
            </td>
          </tr>
        `;

        if (selClientes) {
          selClientes.innerHTML += `
            <option value="${i}">${c.nombre} (${c.nit || "sin NIT"})</option>
          `;
        }
      });

      actualizarInfoRegimen();
      renderGanancias();
      renderDashboard();
    }

    function resetFormCliente() {
      document.getElementById("formCliente").reset();
      document.getElementById("clienteIndex").value = "";
      document.getElementById("cli_estado").value = "Activo";
      document.getElementById("cli_regimen").value = "Peque√±o contribuyente";
    }

    document
      .getElementById("formCliente")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        const idx = document.getElementById("clienteIndex").value;

        const cliente = {
          nombre: document.getElementById("cli_nombre").value.trim(),
          nit: document.getElementById("cli_nit").value.trim(),
          nrc: document.getElementById("cli_nrc").value.trim(),
          giro: document.getElementById("cli_giro").value.trim(),
          correo: document.getElementById("cli_correo").value.trim(),
          telefono: document.getElementById("cli_telefono").value.trim(),
          regimen: document.getElementById("cli_regimen").value,
          fechaInscripcion:
            document.getElementById("cli_fechaInscripcion").value,
          estado: document.getElementById("cli_estado").value,
        };

        if (idx === "") {
          clientes.push(cliente);
        } else {
          clientes[parseInt(idx)] = cliente;
        }

        guardarStorage();
        renderClientes();
        resetFormCliente();
      });

    function editarCliente(i) {
      const c = clientes[i];
      document.getElementById("clienteIndex").value = i;
      document.getElementById("cli_nombre").value = c.nombre;
      document.getElementById("cli_nit").value = c.nit;
      document.getElementById("cli_nrc").value = c.nrc;
      document.getElementById("cli_giro").value = c.giro;
      document.getElementById("cli_correo").value = c.correo;
      document.getElementById("cli_telefono").value = c.telefono;
      document.getElementById("cli_regimen").value =
        mostrarNombreRegimen(c.regimen);
      document.getElementById("cli_fechaInscripcion").value =
        c.fechaInscripcion;
      document.getElementById("cli_estado").value = c.estado;
    }

    function eliminarCliente(i) {
      if (!confirm("¬øSeguro que deseas eliminar este cliente? Esto no borra sus declaraciones existentes.")) return;
      clientes.splice(i, 1);
      guardarStorage();
      renderClientes();
      renderDeclaraciones();
      renderGanancias();
      renderDashboard();
    }

    // ======= DECLARACIONES =======
    function renderDeclaraciones() {
      const tbody = document.getElementById("tablaDeclaraciones");
      tbody.innerHTML = "";

      calcularSaldosIVA();

      declaraciones.forEach((d, i) => {
        const clienteObj = clientes[d.idCliente];
        const clienteNombre = clienteObj ? clienteObj.nombre : "(cliente eliminado)";
        const regimen = clienteObj ? mostrarNombreRegimen(clienteObj.regimen) : "-";

        const chipClass =
          d.estado === "Presentado"
            ? "chip chip-presentado"
            : d.estado === "Con multa"
            ? "chip chip-multa"
            : "chip chip-pendiente";

        const saldoIVA = Number(d.saldoIVA || 0);

        tbody.innerHTML += `
          <tr>
            <td>${clienteNombre}</td>
            <td>${regimen}</td>
            <td>${d.mes}/${d.anio}</td>
            <td>$${Number(d.debitoFiscal || 0).toFixed(2)}</td>
            <td>$${Number(d.creditoFiscal || 0).toFixed(2)}</td>
            <td>$${Number(d.ivaPagar || 0).toFixed(2)}</td>
            <td>$${Number(d.pagoCuenta || 0).toFixed(2)}</td>
            <td>$${Number(d.isrEstimado || 0).toFixed(2)}</td>
            <td>$${saldoIVA.toFixed(2)}</td>
            <td><span class="${chipClass}">${d.estado}</span></td>
            <td class="text-end">
              <button class="btn btn-outline-dark btn-sm" onclick="editarDeclaracion(${i})">Editar</button>
              <button class="btn btn-outline-danger btn-sm" onclick="eliminarDeclaracion(${i})">Borrar</button>
            </td>
          </tr>
        `;
      });

      renderGanancias();
      renderDashboard();
    }

    function resetFormDeclaracion() {
      document.getElementById("formDeclaracion").reset();
      document.getElementById("decIndex").value = "";
      document.getElementById("dec_estado").value = "Pendiente";
      document.getElementById("dec_ventasGravadas").value = 0;
      document.getElementById("dec_ventasExentas").value = 0;
      document.getElementById("dec_comprasGravadas").value = 0;
      document.getElementById("dec_comprasExentas").value = 0;
      document.getElementById("dec_creditoFiscal").value = 0;
      document.getElementById("dec_debitoFiscal").value = 0;
      document.getElementById("dec_ivaPagar").value = 0;
      document.getElementById("dec_pagoCuenta").value = 0;
      document.getElementById("dec_isrEstimado").value = 0;
      actualizarInfoRegimen();
    }

    document
      .getElementById("formDeclaracion")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        const idx = document.getElementById("decIndex").value;

        const declaracion = {
          idCliente: parseInt(document.getElementById("dec_idCliente").value, 10),
          mes: parseInt(document.getElementById("dec_mes").value, 10),
          anio: parseInt(document.getElementById("dec_anio").value, 10),
          ventasGravadas: parseFloat(document.getElementById("dec_ventasGravadas").value) || 0,
          ventasExentas: parseFloat(document.getElementById("dec_ventasExentas").value) || 0,
          comprasGravadas: parseFloat(document.getElementById("dec_comprasGravadas").value) || 0,
          comprasExentas: parseFloat(document.getElementById("dec_comprasExentas").value) || 0,
          creditoFiscal: parseFloat(document.getElementById("dec_creditoFiscal").value) || 0,
          debitoFiscal: parseFloat(document.getElementById("dec_debitoFiscal").value) || 0,
          ivaPagar: parseFloat(document.getElementById("dec_ivaPagar").value) || 0,
          pagoCuenta: parseFloat(document.getElementById("dec_pagoCuenta").value) || 0,
          isrEstimado: parseFloat(document.getElementById("dec_isrEstimado").value) || 0,
          fechaPresentacion: document.getElementById("dec_fechaPresentacion").value,
          estado: document.getElementById("dec_estado").value,
          observaciones: document.getElementById("dec_observaciones").value.trim(),
        };

        if (isNaN(declaracion.idCliente)) {
          alert("Selecciona un cliente.");
          return;
        }

        if (idx === "") {
          declaraciones.push(declaracion);
        } else {
          declaraciones[parseInt(idx)] = declaracion;
        }

        guardarStorage();
        renderDeclaraciones();
        resetFormDeclaracion();
        renderGanancias();
        renderDashboard();
      });

    function editarDeclaracion(i) {
      const d = declaraciones[i];
      document.getElementById("decIndex").value = i;
      document.getElementById("dec_idCliente").value = d.idCliente;
      document.getElementById("dec_mes").value = d.mes;
      document.getElementById("dec_anio").value = d.anio;
      document.getElementById("dec_ventasGravadas").value = d.ventasGravadas;
      document.getElementById("dec_ventasExentas").value = d.ventasExentas;
      document.getElementById("dec_comprasGravadas").value = d.comprasGravadas;
      document.getElementById("dec_comprasExentas").value = d.comprasExentas;
      document.getElementById("dec_creditoFiscal").value = d.creditoFiscal;
      document.getElementById("dec_debitoFiscal").value = d.debitoFiscal;
      document.getElementById("dec_ivaPagar").value = d.ivaPagar;
      document.getElementById("dec_pagoCuenta").value = d.pagoCuenta || 0;
      document.getElementById("dec_isrEstimado").value = d.isrEstimado || 0;
      document.getElementById("dec_fechaPresentacion").value = d.fechaPresentacion;
      document.getElementById("dec_estado").value = d.estado;
      document.getElementById("dec_observaciones").value = d.observaciones;
      actualizarInfoRegimen();
    }

    function eliminarDeclaracion(i) {
      if (!confirm("¬øSeguro que deseas eliminar esta declaraci√≥n?")) return;
      declaraciones.splice(i, 1);
      guardarStorage();
      renderDeclaraciones();
      renderGanancias();
      renderDashboard();
    }

    // ======= GANANCIAS ESTIMADAS =======
    function renderGanancias() {
      const tbodyDet = document.getElementById("tablaGananciasDetalle");
      const tbodyCli = document.getElementById("tablaGananciasClientes");
      const selFiltro = document.getElementById("filtroGanCliente");

      if (!tbodyDet || !tbodyCli || !selFiltro) return;

      tbodyDet.innerHTML = "";
      tbodyCli.innerHTML = "";

      const filtroVal = selFiltro.value;
      const filtroId = filtroVal !== "" ? parseInt(filtroVal, 10) : null;

      const resumen = {};

      declaraciones.forEach(d => {
        if (filtroId !== null && d.idCliente !== filtroId) return;

        const cli = clientes[d.idCliente];
        const nombre = cli ? cli.nombre : "(cliente eliminado)";
        const regimen = cli ? mostrarNombreRegimen(cli.regimen) : "-";

        const ventas = (Number(d.ventasGravadas || 0) + Number(d.ventasExentas || 0));
        const compras = (Number(d.comprasGravadas || 0) + Number(d.comprasExentas || 0));
        const utilidad = ventas - compras;
        const ivaPagado = Math.max(0, Number(d.ivaPagar || 0));
        const pagoCta = Number(d.pagoCuenta || 0);
        const isr = Number(d.isrEstimado || 0);
        const impuestosTotales = ivaPagado + pagoCta + isr;
        const gananciaNeta = utilidad - impuestosTotales;

        tbodyDet.innerHTML += `
          <tr>
            <td>${nombre}</td>
            <td>${regimen}</td>
            <td>${d.mes}/${d.anio}</td>
            <td>$${ventas.toFixed(2)}</td>
            <td>$${compras.toFixed(2)}</td>
            <td>$${utilidad.toFixed(2)}</td>
            <td>$${ivaPagado.toFixed(2)}</td>
            <td>$${pagoCta.toFixed(2)}</td>
            <td>$${isr.toFixed(2)}</td>
            <td>$${impuestosTotales.toFixed(2)}</td>
            <td>$${gananciaNeta.toFixed(2)}</td>
          </tr>
        `;

        const key = d.idCliente;
        if (!resumen[key]) {
          resumen[key] = {
            nombre,
            regimen,
            ventas: 0,
            compras: 0,
            utilidad: 0,
            iva: 0,
            pagoCta: 0,
            isr: 0,
            impuestosTotales: 0,
            gananciaNeta: 0,
          };
        }
        resumen[key].ventas += ventas;
        resumen[key].compras += compras;
        resumen[key].utilidad += utilidad;
        resumen[key].iva += ivaPagado;
        resumen[key].pagoCta += pagoCta;
        resumen[key].isr += isr;
        resumen[key].impuestosTotales += impuestosTotales;
        resumen[key].gananciaNeta += gananciaNeta;
      });

      Object.keys(resumen).forEach(k => {
        const r = resumen[k];
        tbodyCli.innerHTML += `
          <tr>
            <td>${r.nombre}</td>
            <td>${r.regimen}</td>
            <td>$${r.ventas.toFixed(2)}</td>
            <td>$${r.compras.toFixed(2)}</td>
            <td>$${r.utilidad.toFixed(2)}</td>
            <td>$${r.iva.toFixed(2)}</td>
            <td>$${r.pagoCta.toFixed(2)}</td>
            <td>$${r.isr.toFixed(2)}</td>
            <td>$${r.impuestosTotales.toFixed(2)}</td>
            <td>$${r.gananciaNeta.toFixed(2)}</td>
          </tr>
        `;
      });

      if (!declaraciones.length || tbodyDet.innerHTML === "") {
        tbodyDet.innerHTML = `
          <tr>
            <td colspan="11" class="text-center text-muted">
              No hay declaraciones registradas (o no hay datos para el filtro actual).
            </td>
          </tr>`;
        tbodyCli.innerHTML = `
          <tr>
            <td colspan="10" class="text-center text-muted">
              Sin resumen disponible.
            </td>
          </tr>`;
      }
    }

    // ======= EVENTO CAMBIO CLIENTE EN DECLARACI√ìN =======
    document.getElementById("dec_idCliente").addEventListener("change", actualizarInfoRegimen);

    // ======= INIT =======
    renderClientes();
    renderDeclaraciones();
    renderGanancias();
    renderDashboard();
  </script>
</body>
</html>
